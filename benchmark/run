#!/bin/sh
# SPDX-FileCopyrightText: (c) 2024 Ring Zero Desenvolvimento de Software LTDA
# SPDX-License-Identifier: GPL-2.0-only

# benchmark duration
MINUTES=3

# number of processes
CONCURRENT=$(($(nproc)*8))

# connections per process
CONN=256

if [ $# -ne 1 ] && [ $# -ne 2 ]; then
	printf "Usage: %s <ipaddr> [http/https]\n" "$(basename $0)" >&2
	exit 1
fi

server_addr="$1"

mkdir -p ./log
	
benchmark_siege() {
	echo "Running siege..." >& 2
	name="$1-$CONCURRENT-concurrent_$MINUTES-minutes"
	siege -R ./etc/siege.conf -c $CONCURRENT -t ${MINUTES}m -q	\
		--log=./log/$name.log "$1://$server_addr"	\
	| tee -a log/$name.json
}

benchmark_ab() {
	echo "Running AB..." >& 2
	name="$1-$CONCURRENT-concurrent_$MINUTES-minutes"
	ab -c $CONCURRENT -k -t $(($MINUTES*60)) "$1://$server_addr/" | tee -a log/$name.ab
}

benchmark_wrk() {
	echo "Running Wrk..." >& 2
	name="$1-$CONCURRENT-concurrent_$MINUTES-minutes_$CONN-connections"
	wrk -c $CONN -d ${MINUTES}m -t $CONCURRENT -H "Connection: keep-alive" \
		--latency "$1://$server_addr" | tee -a log/$name.wrk
}

benchmark() {
	benchmark_siege "$*"
	benchmark_ab "$*"
	benchmark_wrk "$*"
}

if [ "$2" = "http" ] || [ "$2" = "https" ]; then
	benchmark "$2"
else
	benchmark "http"
	benchmark "https"
fi

